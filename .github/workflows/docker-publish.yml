name: Build and Publish Docker Images

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:
  repository_dispatch:
    types: [docker-build-triggered]

permissions:
  contents: read
  packages: write
  actions: write

env:
  REGISTRY: ghcr.io

jobs:
  # æ£€æµ‹æ–‡ä»¶å˜æ›´ï¼ˆä»… main åˆ†æ”¯æ™®é€šæ¨é€æ—¶æ‰§è¡Œï¼‰
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      remote-gateway: ${{ steps.filter.outputs.remote-gateway }}
      should_build_all: ${{ steps.check.outputs.should_build_all }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦å…¨é‡æ„å»º
        id: check
        run: |
          # Tag æ¨é€ã€repository_dispatchã€workflow_dispatch æ—¶å…¨é‡æ„å»º
          if [[ "${{ github.ref }}" =~ ^refs/tags/v ]]; then
            echo "should_build_all=true" >> $GITHUB_OUTPUT
            echo "âœ… Tag æ¨é€ï¼Œå°†å…¨é‡æ„å»ºæ‰€æœ‰é•œåƒ"
          elif [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "should_build_all=true" >> $GITHUB_OUTPUT
            echo "âœ… repository_dispatch è§¦å‘ï¼Œå°†å…¨é‡æ„å»ºæ‰€æœ‰é•œåƒ"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_build_all=true" >> $GITHUB_OUTPUT
            echo "âœ… æ‰‹åŠ¨è§¦å‘ï¼Œå°†å…¨é‡æ„å»ºæ‰€æœ‰é•œåƒ"
          else
            echo "should_build_all=false" >> $GITHUB_OUTPUT
            echo "âœ… main åˆ†æ”¯æ¨é€ï¼Œå°†æ£€æµ‹å˜æ›´æŒ‰éœ€æ„å»º"
          fi

      - name: æ£€æµ‹æ–‡ä»¶å˜æ›´
        if: steps.check.outputs.should_build_all == 'false'
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'packages/backend/**'
              - 'package.json'
              - 'package-lock.json'
            frontend:
              - 'packages/frontend/**'
              - 'package.json'
              - 'package-lock.json'
            remote-gateway:
              - 'packages/remote-gateway/**'
              - 'package.json'
              - 'package-lock.json'

      - name: è¾“å‡ºå˜æ›´æ£€æµ‹ç»“æœ
        run: |
          echo "=========================================="
          echo "å˜æ›´æ£€æµ‹ç»“æœï¼š"
          echo "  å…¨é‡æ„å»º: ${{ steps.check.outputs.should_build_all }}"
          if [[ "${{ steps.check.outputs.should_build_all }}" == "false" ]]; then
            echo "  backend å˜æ›´: ${{ steps.filter.outputs.backend }}"
            echo "  frontend å˜æ›´: ${{ steps.filter.outputs.frontend }}"
            echo "  remote-gateway å˜æ›´: ${{ steps.filter.outputs.remote-gateway }}"
          fi
          echo "=========================================="

  # æ„å»º Backend é•œåƒ
  build-backend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should_build_all == 'true' || needs.detect-changes.outputs.backend == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: è¯»å–ç‰ˆæœ¬å·
        id: version
        run: |
          PAYLOAD_VERSION=$(jq -r '.client_payload.version // ""' "$GITHUB_EVENT_PATH")
          if [ -n "$PAYLOAD_VERSION" ]; then
            VERSION="$PAYLOAD_VERSION"
            echo "âœ… ä½¿ç”¨ payload ä¸­çš„ç‰ˆæœ¬å·ï¼š$VERSION"
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            VERSION="dev"
            echo "âœ… ä½¿ç”¨ main åˆ†æ”¯ç‰ˆæœ¬å·ï¼š$VERSION"
          else
            VERSION=$(cat VERSION 2>/dev/null | tr -d '[:space:]' || echo "latest")
            echo "âœ… ä½¿ç”¨ VERSION æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å·ï¼š$VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: åˆ¤æ–­æ„å»ºç±»å‹
        id: build_type
        run: |
          PAYLOAD_VERSION=$(jq -r '.client_payload.version // ""' "$GITHUB_EVENT_PATH")
          if [[ "${{ github.event_name }}" == "repository_dispatch" && -n "$PAYLOAD_VERSION" ]]; then
            echo "BUILD_TYPE=release" >> $GITHUB_OUTPUT
            echo "IS_TAG_PUSH=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ° repository_dispatchï¼ˆç‰ˆæœ¬ï¼š$PAYLOAD_VERSIONï¼‰ï¼Œæ„å»º release é•œåƒ"
          elif [[ "${{ github.ref }}" =~ ^refs/tags/v ]]; then
            echo "BUILD_TYPE=release" >> $GITHUB_OUTPUT
            echo "IS_TAG_PUSH=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°æ ‡ç­¾æ¨é€ï¼Œæ„å»º release é•œåƒ"
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "BUILD_TYPE=dev" >> $GITHUB_OUTPUT
            echo "IS_TAG_PUSH=false" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ° main åˆ†æ”¯æ¨é€ï¼Œæ„å»º dev é•œåƒ"
          else
            echo "BUILD_TYPE=manual" >> $GITHUB_OUTPUT
            echo "IS_TAG_PUSH=false" >> $GITHUB_OUTPUT
            echo "âœ… æ‰‹åŠ¨è§¦å‘æˆ–å…¶ä»–æƒ…å†µ"
          fi

      - name: æ›´æ–° VERSION æ–‡ä»¶ï¼ˆmain åˆ†æ”¯æ„å»ºæ—¶ï¼‰
        if: steps.build_type.outputs.BUILD_TYPE == 'dev'
        run: |
          echo "dev" > VERSION
          echo "âœ… å·²æ›´æ–° VERSION æ–‡ä»¶ä¸º 'dev'"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}-backend
          tags: |
            type=raw,value=dev,enable=${{ steps.build_type.outputs.BUILD_TYPE == 'dev' }}
            type=raw,value=latest,enable=${{ steps.build_type.outputs.IS_TAG_PUSH == 'true' }}
            type=raw,value=${{ steps.version.outputs.VERSION }},enable=${{ steps.build_type.outputs.IS_TAG_PUSH == 'true' && steps.version.outputs.VERSION != '' }}
            type=sha,enable=${{ steps.build_type.outputs.IS_TAG_PUSH == 'true' }}
            type=ref,event=branch,enable=${{ steps.build_type.outputs.BUILD_TYPE != 'dev' && steps.build_type.outputs.IS_TAG_PUSH != 'true' }}
            type=ref,event=tag,enable=${{ steps.build_type.outputs.IS_TAG_PUSH != 'true' }}
            type=sha,enable=${{ steps.build_type.outputs.IS_TAG_PUSH != 'true' }}

      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
          context: .
          file: packages/backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
          sbom: false

      - name: Show published tags
        run: |
          echo "ğŸš€ Backend é•œåƒæ„å»ºå®Œæˆ"
          echo "Published: ${{ steps.meta.outputs.tags }}"

  # æ„å»º Frontend é•œåƒ
  build-frontend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should_build_all == 'true' || needs.detect-changes.outputs.frontend == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: è¯»å–ç‰ˆæœ¬å·
        id: version
        run: |
          PAYLOAD_VERSION=$(jq -r '.client_payload.version // ""' "$GITHUB_EVENT_PATH")
          if [ -n "$PAYLOAD_VERSION" ]; then
            VERSION="$PAYLOAD_VERSION"
            echo "âœ… ä½¿ç”¨ payload ä¸­çš„ç‰ˆæœ¬å·ï¼š$VERSION"
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            VERSION="dev"
            echo "âœ… ä½¿ç”¨ main åˆ†æ”¯ç‰ˆæœ¬å·ï¼š$VERSION"
          else
            VERSION=$(cat VERSION 2>/dev/null | tr -d '[:space:]' || echo "latest")
            echo "âœ… ä½¿ç”¨ VERSION æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å·ï¼š$VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: åˆ¤æ–­æ„å»ºç±»å‹
        id: build_type
        run: |
          PAYLOAD_VERSION=$(jq -r '.client_payload.version // ""' "$GITHUB_EVENT_PATH")
          if [[ "${{ github.event_name }}" == "repository_dispatch" && -n "$PAYLOAD_VERSION" ]]; then
            echo "BUILD_TYPE=release" >> $GITHUB_OUTPUT
            echo "IS_TAG_PUSH=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ ^refs/tags/v ]]; then
            echo "BUILD_TYPE=release" >> $GITHUB_OUTPUT
            echo "IS_TAG_PUSH=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "BUILD_TYPE=dev" >> $GITHUB_OUTPUT
            echo "IS_TAG_PUSH=false" >> $GITHUB_OUTPUT
          else
            echo "BUILD_TYPE=manual" >> $GITHUB_OUTPUT
            echo "IS_TAG_PUSH=false" >> $GITHUB_OUTPUT
          fi

      - name: æ›´æ–° VERSION æ–‡ä»¶ï¼ˆmain åˆ†æ”¯æ„å»ºæ—¶ï¼‰
        if: steps.build_type.outputs.BUILD_TYPE == 'dev'
        run: |
          echo "dev" > VERSION

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}-frontend
          tags: |
            type=raw,value=dev,enable=${{ steps.build_type.outputs.BUILD_TYPE == 'dev' }}
            type=raw,value=latest,enable=${{ steps.build_type.outputs.IS_TAG_PUSH == 'true' }}
            type=raw,value=${{ steps.version.outputs.VERSION }},enable=${{ steps.build_type.outputs.IS_TAG_PUSH == 'true' && steps.version.outputs.VERSION != '' }}
            type=sha,enable=${{ steps.build_type.outputs.IS_TAG_PUSH == 'true' }}
            type=ref,event=branch,enable=${{ steps.build_type.outputs.BUILD_TYPE != 'dev' && steps.build_type.outputs.IS_TAG_PUSH != 'true' }}
            type=ref,event=tag,enable=${{ steps.build_type.outputs.IS_TAG_PUSH != 'true' }}
            type=sha,enable=${{ steps.build_type.outputs.IS_TAG_PUSH != 'true' }}

      - name: Build and push frontend
        uses: docker/build-push-action@v6
        with:
          context: .
          file: packages/frontend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
          sbom: false

      - name: Show published tags
        run: |
          echo "ğŸš€ Frontend é•œåƒæ„å»ºå®Œæˆ"
          echo "Published: ${{ steps.meta.outputs.tags }}"

  # æ„å»º Remote Gateway é•œåƒ
  build-remote-gateway:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should_build_all == 'true' || needs.detect-changes.outputs.remote-gateway == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: è¯»å–ç‰ˆæœ¬å·
        id: version
        run: |
          PAYLOAD_VERSION=$(jq -r '.client_payload.version // ""' "$GITHUB_EVENT_PATH")
          if [ -n "$PAYLOAD_VERSION" ]; then
            VERSION="$PAYLOAD_VERSION"
            echo "âœ… ä½¿ç”¨ payload ä¸­çš„ç‰ˆæœ¬å·ï¼š$VERSION"
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            VERSION="dev"
            echo "âœ… ä½¿ç”¨ main åˆ†æ”¯ç‰ˆæœ¬å·ï¼š$VERSION"
          else
            VERSION=$(cat VERSION 2>/dev/null | tr -d '[:space:]' || echo "latest")
            echo "âœ… ä½¿ç”¨ VERSION æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å·ï¼š$VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: åˆ¤æ–­æ„å»ºç±»å‹
        id: build_type
        run: |
          PAYLOAD_VERSION=$(jq -r '.client_payload.version // ""' "$GITHUB_EVENT_PATH")
          if [[ "${{ github.event_name }}" == "repository_dispatch" && -n "$PAYLOAD_VERSION" ]]; then
            echo "BUILD_TYPE=release" >> $GITHUB_OUTPUT
            echo "IS_TAG_PUSH=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ ^refs/tags/v ]]; then
            echo "BUILD_TYPE=release" >> $GITHUB_OUTPUT
            echo "IS_TAG_PUSH=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "BUILD_TYPE=dev" >> $GITHUB_OUTPUT
            echo "IS_TAG_PUSH=false" >> $GITHUB_OUTPUT
          else
            echo "BUILD_TYPE=manual" >> $GITHUB_OUTPUT
            echo "IS_TAG_PUSH=false" >> $GITHUB_OUTPUT
          fi

      - name: æ›´æ–° VERSION æ–‡ä»¶ï¼ˆmain åˆ†æ”¯æ„å»ºæ—¶ï¼‰
        if: steps.build_type.outputs.BUILD_TYPE == 'dev'
        run: |
          echo "dev" > VERSION

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}-remote-gateway
          tags: |
            type=raw,value=dev,enable=${{ steps.build_type.outputs.BUILD_TYPE == 'dev' }}
            type=raw,value=latest,enable=${{ steps.build_type.outputs.IS_TAG_PUSH == 'true' }}
            type=raw,value=${{ steps.version.outputs.VERSION }},enable=${{ steps.build_type.outputs.IS_TAG_PUSH == 'true' && steps.version.outputs.VERSION != '' }}
            type=sha,enable=${{ steps.build_type.outputs.IS_TAG_PUSH == 'true' }}
            type=ref,event=branch,enable=${{ steps.build_type.outputs.BUILD_TYPE != 'dev' && steps.build_type.outputs.IS_TAG_PUSH != 'true' }}
            type=ref,event=tag,enable=${{ steps.build_type.outputs.IS_TAG_PUSH != 'true' }}
            type=sha,enable=${{ steps.build_type.outputs.IS_TAG_PUSH != 'true' }}

      - name: Build and push remote-gateway
        uses: docker/build-push-action@v6
        with:
          context: .
          file: packages/remote-gateway/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
          sbom: false

      - name: Show published tags
        run: |
          echo "ğŸš€ Remote Gateway é•œåƒæ„å»ºå®Œæˆ"
          echo "Published: ${{ steps.meta.outputs.tags }}"

  # æ¸…ç†æ—§çš„ workflow è¿è¡Œè®°å½•
  cleanup-old-runs:
    name: Cleanup workflow runs (3 days)
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend, build-remote-gateway]
    if: always()
    steps:
      - name: Delete runs older than 3 days
        uses: actions/github-script@v7
        with:
          script: |
            const { repo, owner } = context.repo;
            const cutoff = Date.now() - 3 * 24 * 60 * 60 * 1000;
            const currentRunId = context.runId;
            let page = 1;
            let total = 0;
            let deleted = 0;

            while (true) {
              const { data } = await github.rest.actions.listWorkflowRunsForRepo({
                owner,
                repo,
                per_page: 100,
                page,
              });

              if (!data.workflow_runs.length) break;

              for (const run of data.workflow_runs) {
                total++;
                if (run.id === currentRunId) continue;
                const created = new Date(run.created_at).getTime();
                const statusOk = ['completed', 'cancelled'].includes(run.status || '');
                if (!statusOk) continue;
                if (created >= cutoff) continue;

                await github.rest.actions.deleteWorkflowRun({ owner, repo, run_id: run.id });
                deleted++;
                core.info(`åˆ é™¤ run ${run.id} (${run.name}) created_at=${run.created_at}`);
              }

              page++;
            }

            core.info(`æ‰«æå®Œæˆï¼šå¤„ç† ${total} æ¡ï¼Œåˆ é™¤ ${deleted} æ¡ï¼Œé˜ˆå€¼=3å¤©ã€‚`);
