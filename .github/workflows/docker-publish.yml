name: Build and Publish Docker Images

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:
  repository_dispatch:
    types: [docker-build-triggered]

permissions:
  contents: read
  packages: write
  actions: write

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - name: backend
            dockerfile: packages/backend/Dockerfile
            image: backend
          - name: frontend
            dockerfile: packages/frontend/Dockerfile
            image: frontend
          - name: remote-gateway
            dockerfile: packages/remote-gateway/Dockerfile
            image: remote-gateway
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: è¯»å–ç‰ˆæœ¬å·
        id: version
        run: |
          # ä» repository_dispatch payload è¯»å–ç‰ˆæœ¬å·
          PAYLOAD_VERSION=$(jq -r '.client_payload.version // ""' "$GITHUB_EVENT_PATH")

          if [ -n "$PAYLOAD_VERSION" ]; then
            VERSION="$PAYLOAD_VERSION"
            echo "âœ… ä½¿ç”¨ payload ä¸­çš„ç‰ˆæœ¬å·ï¼š$VERSION"
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            # main åˆ†æ”¯æ„å»ºæ—¶ä½¿ç”¨ dev ç‰ˆæœ¬å·
            VERSION="dev"
            echo "âœ… ä½¿ç”¨ main åˆ†æ”¯ç‰ˆæœ¬å·ï¼š$VERSION"
          else
            # ä» VERSION æ–‡ä»¶è¯»å–
            VERSION=$(cat VERSION 2>/dev/null | tr -d '[:space:]' || echo "latest")
            echo "âœ… ä½¿ç”¨ VERSION æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å·ï¼š$VERSION"
          fi

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: åˆ¤æ–­æ„å»ºç±»å‹
        id: build_type
        run: |
          # æ£€æµ‹æ˜¯å¦æ¥è‡ª repository_dispatchï¼ˆç”±æ„å»ºä¸å‘å¸ƒè§¦å‘ï¼‰
          PAYLOAD_VERSION=$(jq -r '.client_payload.version // ""' "$GITHUB_EVENT_PATH")

          if [[ "${{ github.event_name }}" == "repository_dispatch" && -n "$PAYLOAD_VERSION" ]]; then
            echo "BUILD_TYPE=release" >> $GITHUB_OUTPUT
            echo "IS_TAG_PUSH=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ° repository_dispatchï¼ˆç‰ˆæœ¬ï¼š$PAYLOAD_VERSIONï¼‰ï¼Œæ„å»º release é•œåƒ"
          elif [[ "${{ github.ref }}" =~ ^refs/tags/v ]]; then
            echo "BUILD_TYPE=release" >> $GITHUB_OUTPUT
            echo "IS_TAG_PUSH=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°æ ‡ç­¾æ¨é€ï¼Œæ„å»º release é•œåƒ"
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "BUILD_TYPE=dev" >> $GITHUB_OUTPUT
            echo "IS_TAG_PUSH=false" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ° main åˆ†æ”¯æ¨é€ï¼Œæ„å»º dev é•œåƒ"
          else
            echo "BUILD_TYPE=manual" >> $GITHUB_OUTPUT
            echo "IS_TAG_PUSH=false" >> $GITHUB_OUTPUT
            echo "âœ… æ‰‹åŠ¨è§¦å‘æˆ–å…¶ä»–æƒ…å†µ"
          fi

      - name: æ›´æ–° VERSION æ–‡ä»¶ï¼ˆmain åˆ†æ”¯æ„å»ºæ—¶ï¼‰
        if: steps.build_type.outputs.BUILD_TYPE == 'dev'
        run: |
          echo "dev" > VERSION
          echo "âœ… å·²æ›´æ–° VERSION æ–‡ä»¶ä¸º 'dev'"
          cat VERSION

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}-${{ matrix.service.image }}
          tags: |
            # main åˆ†æ”¯æ¨é€æ—¶æ„å»º dev æ ‡ç­¾
            type=raw,value=dev,enable=${{ steps.build_type.outputs.BUILD_TYPE == 'dev' }}

            # tag æ¨é€æ—¶æ„å»º latest å’Œç‰ˆæœ¬å·æ ‡ç­¾
            type=raw,value=latest,enable=${{ steps.build_type.outputs.IS_TAG_PUSH == 'true' }}
            type=raw,value=${{ steps.version.outputs.VERSION }},enable=${{ steps.build_type.outputs.IS_TAG_PUSH == 'true' && steps.version.outputs.VERSION != '' }}
            type=ref,event=tag,enable={{is_default_branch}}

            # å…¶ä»–æƒ…å†µï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰çš„å¤‡ç”¨æ ‡ç­¾
            type=ref,event=branch,enable=${{ steps.build_type.outputs.BUILD_TYPE != 'dev' }}
            type=ref,event=tag
            type=sha

      - name: Build and push ${{ matrix.service.name }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
          sbom: false

      - name: Show published tags
        run: |
          echo "æ„å»ºç±»å‹: ${{ steps.build_type.outputs.BUILD_TYPE }}"
          echo "Published: ${{ steps.meta.outputs.tags }}"
          echo "================================================"
          if [[ "${{ steps.build_type.outputs.BUILD_TYPE }}" == "dev" ]]; then
            echo "ğŸš€ å·²æ„å»º dev é•œåƒï¼ˆä» main åˆ†æ”¯ï¼‰"
          elif [[ "${{ steps.build_type.outputs.IS_TAG_PUSH }}" == "true" ]]; then
            echo "ğŸ‰ å·²æ„å»º release é•œåƒï¼ˆlatest + ç‰ˆæœ¬å·ï¼‰"
          else
            echo "ğŸ”§ æ‰‹åŠ¨è§¦å‘æ„å»º"
          fi

  cleanup-old-runs:
    name: Cleanup workflow runs (3 days)
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Delete runs older than 3 days
        uses: actions/github-script@v7
        with:
          script: |
            const { repo, owner } = context.repo;
            const cutoff = Date.now() - 3 * 24 * 60 * 60 * 1000;
            const currentRunId = context.runId;
            let page = 1;
            let total = 0;
            let deleted = 0;

            while (true) {
              const { data } = await github.rest.actions.listWorkflowRunsForRepo({
                owner,
                repo,
                per_page: 100,
                page,
              });

              if (!data.workflow_runs.length) break;

              for (const run of data.workflow_runs) {
                total++;
                if (run.id === currentRunId) continue;
                const created = new Date(run.created_at).getTime();
                const statusOk = ['completed', 'cancelled'].includes(run.status || '');
                if (!statusOk) continue;
                if (created >= cutoff) continue;

                await github.rest.actions.deleteWorkflowRun({ owner, repo, run_id: run.id });
                deleted++;
                core.info(`åˆ é™¤ run ${run.id} (${run.name}) created_at=${run.created_at}`);
              }

              page++;
            }

            core.info(`æ‰«æå®Œæˆï¼šå¤„ç† ${total} æ¡ï¼Œåˆ é™¤ ${deleted} æ¡ï¼Œé˜ˆå€¼=3å¤©ã€‚`);
